<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Simulatore Google Cloud Digital Leader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --g-blue: #1a73e8;
      --g-red: #ea4335;
      --g-green: #34a853;
      --g-gray: #f1f3f4;
      --g-text: #202124;
    }

    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 10px;
      color: var(--g-text);
    }

    .container {
      max-width: 850px;
      margin: 15px auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .progress-container {
      width: 100%;
      background: #eee;
      height: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: var(--g-blue);
      width: 0%;
      transition: width 0.4s ease;
    }

    h1 { font-size: 1.8rem; text-align: center; margin-bottom: 20px; }

    .btn {
      width: 100%;
      padding: 15px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #dadce0;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      color: var(--g-text);
    }

    .btn:hover:not(:disabled) { background: var(--g-gray); }
    
    .btn-blue {
      background: var(--g-blue) !important;
      color: white !important;
      font-weight: bold;
    }

    .is-correct {
      background: #e6f4ea !important;
      border-color: var(--g-green) !important;
      color: #137333 !important;
      font-weight: bold;
    }
    .is-wrong {
      background: #fce8e6 !important;
      border-color: var(--g-red) !important;
      color: #c5221f !important;
    }

    .explanation-box {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-left: 5px solid var(--g-blue);
      border-radius: 4px;
      font-size: 0.95rem;
    }

    .hidden { display: none; }

    #nextBtn {
      background: var(--g-green);
      color: white;
      border: none;
      padding: 16px;
      font-weight: bold;
      margin-top: 15px;
      justify-content: center;
    }

    #loading-status {
      text-align: center;
      font-size: 0.9rem;
      color: var(--g-red);
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<div class="container">
  <div id="start-screen">
    <h1>Cloud Digital Leader Simulator</h1>
    <div id="loading-status">Caricamento domande in corso...</div>
    <p style="text-align: center; margin-bottom: 30px;">Scegli la durata del test:</p>
    
    <button onclick="startExam(10)" class="btn">Test Rapido (10 domande)</button>
    <button onclick="startExam(20)" class="btn">Test Standard (20 domande)</button>
    <button onclick="startExam(50)" class="btn">Simulazione Completa (50 domande)</button>
    <button id="btn-all" onclick="startExam(9999)" class="btn" style="border-style: dashed;">Tutte le domande (---)</button>
  </div>

  <div id="quiz-screen" class="hidden">
    <div class="progress-container"><div id="bar" class="progress-bar"></div></div>
    <div id="status" style="font-weight: bold; color: #70757a; margin-bottom: 5px;"></div>
    <div id="question" style="font-size: 1.25rem; font-weight: 500; margin-bottom: 25px;"></div>
    <div id="options"></div>
    <div id="explanation" class="hidden"></div>
    <button id="nextBtn" class="btn hidden">Prossima Domanda âž”</button>
  </div>

  <div id="result-screen" class="hidden" style="text-align: center;">
    <h2 id="res-title"></h2>
    <p id="res-score" style="font-size: 2rem; margin: 20px 0;"></p>
    <p id="res-feedback"></p>
    <div id="result-actions">
        <button id="retry-errors-btn" class="btn btn-blue" style="justify-content: center; margin-bottom: 10px;">Riesamina Errori</button>
        <button onclick="location.reload()" class="btn" style="justify-content: center; border-color: var(--g-blue); color: var(--g-blue);">Ricomincia da Capo</button>
    </div>
  </div>
</div>

<script>
/**
 * GESTIONE DATI ESTERNI
 */
let allQuestions = [];
let selectedQuestions = [];
let wrongQuestions = [];
let currentIdx = 0;
let score = 0;

// Caricamento asincrono del JSON
async function loadQuestions() {
    try {
        const response = await fetch('questions.json');
        if (!response.ok) throw new Error("File JSON non trovato o errore server");
        allQuestions = await response.json();
        
        // Aggiorna interfaccia una volta pronti
        document.getElementById('loading-status').classList.add('hidden');
        document.getElementById('btn-all').innerText = `Tutte le domande (${allQuestions.length})`;
    } catch (err) {
        console.error(err);
        document.getElementById('loading-status').innerText = "Errore nel caricamento delle domande. Controlla il file questions.json.";
    }
}

// Avvia il caricamento
loadQuestions();

function startExam(num, subset = null) {
  if (allQuestions.length === 0) return;

  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('result-screen').classList.add('hidden');
  document.getElementById('quiz-screen').classList.remove('hidden');
  
  if (subset) {
    selectedQuestions = [...subset];
  } else {
    const shuffled = [...allQuestions].sort(() => Math.random() - 0.5);
    selectedQuestions = shuffled.slice(0, Math.min(num, allQuestions.length));
  }
  
  wrongQuestions = [];
  currentIdx = 0;
  score = 0;
  showQuestion();
}

function showQuestion() {
  const q = selectedQuestions[currentIdx];
  const bar = document.getElementById('bar');
  const status = document.getElementById('status');
  const optionsDiv = document.getElementById('options');
  const explDiv = document.getElementById('explanation');
  const nextBtn = document.getElementById('nextBtn');

  bar.style.width = `${(currentIdx / selectedQuestions.length) * 100}%`;
  status.innerText = `DOMANDA ${currentIdx + 1} DI ${selectedQuestions.length}`;
  document.getElementById('question').innerText = q.question;
  optionsDiv.innerHTML = '';
  explDiv.classList.add('hidden');
  nextBtn.classList.add('hidden');

  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.innerText = opt;
    btn.onclick = () => handleSelection(i, btn);
    optionsDiv.appendChild(btn);
  });
}

function handleSelection(idx, btn) {
  const q = selectedQuestions[currentIdx];
  const buttons = document.querySelectorAll('#options .btn');
  const explDiv = document.getElementById('explanation');
  const nextBtn = document.getElementById('nextBtn');

  buttons.forEach(b => b.disabled = true);

  if (idx === q.answer) {
    btn.classList.add('is-correct');
    btn.innerHTML += ' <span>âœ”</span>';
    score++;
  } else {
    btn.classList.add('is-wrong');
    btn.innerHTML += ' <span>âœ˜</span>';
    buttons[q.answer].classList.add('is-correct');
    buttons[q.answer].innerHTML += ' <span>âœ”</span>';
    wrongQuestions.push(q);
  }

  // Box con ANALISI COMPLETA di tutte le opzioni
  let detailedExpl = `<div class="explanation-box"><strong>Analisi delle opzioni:</strong><br><ul style="padding-left: 20px; margin-top: 10px;">`;
  q.options.forEach((opt, i) => {
    const isCorrect = (i === q.answer);
    detailedExpl += `<li style="margin-bottom: 8px;">
      <span style="color: ${isCorrect ? 'var(--g-green)' : 'var(--g-red)'}; font-weight: bold;">${opt}:</span> 
      ${q.explanation[i]}
    </li>`;
  });
  detailedExpl += `</ul></div>`;

  explDiv.innerHTML = detailedExpl;
  explDiv.classList.remove('hidden');
  nextBtn.classList.remove('hidden');
  
  setTimeout(() => nextBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
}

document.getElementById('nextBtn').onclick = () => {
  currentIdx++;
  if (currentIdx < selectedQuestions.length) {
    showQuestion();
  } else {
    showFinalResults();
  }
};

function showFinalResults() {
  document.getElementById('quiz-screen').classList.add('hidden');
  const resScreen = document.getElementById('result-screen');
  const retryBtn = document.getElementById('retry-errors-btn');
  resScreen.classList.remove('hidden');
  
  const pct = (score / selectedQuestions.length) * 100;
  document.getElementById('res-title').innerText = pct >= 70 ? "Esame Superato! ðŸ†" : "Non superato ðŸ“š";
  document.getElementById('res-score').innerText = `${score} / ${selectedQuestions.length} (${pct.toFixed(1)}%)`;
  document.getElementById('res-feedback').innerText = pct >= 70 
    ? "Ottima preparazione! Sei pronto per il test ufficiale." 
    : "Ti consigliamo di ripassare i concetti e riprovare la simulazione.";

  if (wrongQuestions.length > 0) {
    retryBtn.classList.remove('hidden');
    retryBtn.innerText = `Riesamina i tuoi errori (${wrongQuestions.length})`;
    retryBtn.onclick = () => startExam(wrongQuestions.length, wrongQuestions);
  } else {
    retryBtn.classList.add('hidden');
  }
}
</script>
</body>
</html>
